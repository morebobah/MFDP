<div class="custom-border bg-white p-6 custom-shadow">
<h2 class="text-xl font-semibold text-gray-800 mb-4">Загрузка Excel файла</h2>
<form id="ml-form" class="space-y-4" name="fileupload" method="post">
    <input type="hidden" id="selector" name="my_hidden_value" value="2">
    <div class="space-y-4">
        <div class="flex items-center justify-center w-full">
            <label for="dropzone-file" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                    <i class="fas fa-file-excel text-3xl text-green-600 mb-2"></i>
                    <p class="text-sm text-gray-500">Перетащите Excel файл сюда или кликните для выбора</p>
                    <p class="text-xs text-gray-400 mt-1">(Поддерживаются .xls, .xlsx)</p>
                </div>
                <input id="dropzone-file" type="file" class="hidden" accept=".xls,.xlsx" name="file"/>
            </label>
            &nbsp;
            <div id="preview-container" class="flex flex-col items-center justify-center w-60 h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
                <h3 class="text-sm font-medium text-gray-700 mb-2" id="preview-notice">Информация о файле:</h3>
                <div id="file-info" class="text-xs text-gray-500 text-center">
                    <i class="fas fa-file-excel text-green-500 text-2xl"></i>
                    <p id="file-name" class="mt-1 truncate w-48"></p>
                    <p id="file-size"></p>
                </div>
            </div>
        </div>
        <input type="hidden" name="user_id" >
        <div class="flex justify-between items-center">
            <span class="text-sm text-gray-500">Макс. размер: 10MB</span>
            <button id="submit-btn" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-1 px-3 rounded transition-colors" switch="1">
                <i class="fas fa-upload mr-1"></i> Загрузить
            </button>
        </div>
    </div>
</form>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('ml-form');
    const fileInput = document.getElementById('dropzone-file');
    const previewContainer = document.getElementById('preview-container');
    const fileNameElement = document.getElementById('file-name');
    const fileSizeElement = document.getElementById('file-size');
    const submitBtn = document.getElementById('submit-btn');

    // Обработка выбора файла
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // Показываем информацию о файле
            fileNameElement.textContent = file.name;
            fileSizeElement.textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`;
            
            // Проверка размера файла
            if (file.size > 10 * 1024 * 1024) {
                alert('Файл слишком большой. Максимальный размер: 10MB');
                fileInput.value = '';
                fileNameElement.textContent = '';
                fileSizeElement.textContent = '';
                return;
            }
        }
    });

    // Обработка отправки формы
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const file = fileInput.files[0];
        if (!file) {
            alert('Пожалуйста, выберите файл для загрузки');
            return;
        }

        // Проверка расширения файла
        if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
            alert('Файл должен быть в формате Excel (.xlsx или .xls)');
            return;
        }

        // Проверка размера файла
        if (file.size > 10 * 1024 * 1024) {
            alert('Файл слишком большой. Максимальный размер: 10MB');
            return;
        }

        // Создаем FormData и добавляем файл
        const formData = new FormData();
        formData.append('file', file);

        // Отправляем файл на сервер
        try {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Загрузка...';
            
            const response = await fetch('/users/user/event/upload/excel/', {
                method: 'POST',
                body: formData,
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                }
            });

            if (response.ok) {
                // При успешной загрузке перезагружаем страницу
                window.location.reload();
            } else {
                const errorData = await response.json();
                alert(errorData.detail || 'Произошла ошибка при загрузке файла');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-upload mr-1"></i> Загрузить';
            }
        } catch (error) {
            console.error('Ошибка:', error);
            alert('Произошла ошибка при загрузке файла');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-upload mr-1"></i> Загрузить';
        }
    });

    // Drag and drop функциональность
    const dropZone = form.querySelector('label[for="dropzone-file"]');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
        dropZone.classList.add('border-blue-500');
        dropZone.classList.remove('border-gray-300');
    }

    function unhighlight() {
        dropZone.classList.remove('border-blue-500');
        dropZone.classList.add('border-gray-300');
    }

    dropZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        fileInput.files = files;
        
        // Триггерим событие change для обновления preview
        const event = new Event('change');
        fileInput.dispatchEvent(event);
    }
    });
</script>