{% include "base.html" %}
{% include "panel.html" %}
<main class="container mx-auto py-8 px-4">
    <div class="grid grid-cols-1 gap-8">
        <!-- Форма добавления строительного мероприятия -->
        <div class="custom-border bg-white p-6 custom-shadow">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Добавить строительное мероприятие</h2>
            <form id="event-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Основные поля -->
                    <div class="space-y-4">
                        <div>
                            <label for="packet_id" class="block text-sm font-medium text-gray-700">Номер пакета</label>
                            <input type="number" id="packet_id" name="packet_id" value="1" required
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="year" class="block text-sm font-medium text-gray-700">Год</label>
                            <input type="number" id="year" name="year" value="2023" required
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="type_of_work" class="block text-sm font-medium text-gray-700">Тип работ (0-город, 1-пригород)</label>
                            <input type="number" step="0.1" id="type_of_work" name="type_of_work" value="0.0" required
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="contractor" class="block text-sm font-medium text-gray-700">Подрядчик</label>
                            <input type="number" step="0.1" id="contractor" name="contractor" value="30.0" required
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="idleft" class="block text-sm font-medium text-gray-700">ID левый</label>
                            <input type="number" id="idleft" name="idleft" value="368838" required
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="idright" class="block text-sm font-medium text-gray-700">ID правый</label>
                            <input type="number" id="idright" name="idright" value="188" required
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>

                    <!-- Технические параметры -->
                    <div class="space-y-4">
                        <div>
                            <label for="g2" class="block text-sm font-medium text-gray-700">2G (бинарный)</label>
                            <input type="number" step="0.1" id="g2" name="g2" value="0.0" required
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="g3" class="block text-sm font-medium text-gray-700">3G (бинарный)</label>
                            <input type="number" step="0.1" id="g3" name="g3" value="0.0" required
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="g4" class="block text-sm font-medium text-gray-700">4G (бинарный)</label>
                            <input type="number" step="0.1" id="g4" name="g4" value="1.0" required
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="rrl" class="block text-sm font-medium text-gray-700">RRL (бинарный)</label>
                            <input type="number" step="0.1" id="rrl" name="rrl" value="0.0" required
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="a_index" class="block text-sm font-medium text-gray-700">Индекс места размещения</label>
                            <input type="number" id="a_index" name="a_index" value="365013" required
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="a_region" class="block text-sm font-medium text-gray-700">Регион размещения</label>
                            <input type="number" step="0.1" id="a_region" name="a_region" value="0.0" required
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="a_place" class="block text-sm font-medium text-gray-700">Признак города (бинарный)</label>
                            <input type="number" step="0.1" id="a_place" name="a_place" value="1.0" required
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>
                </div>

                <!-- Даты этапов -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                    <div>
                        <label for="date_start" class="block text-sm font-medium text-gray-700">Дата начала работ</label>
                        <input type="datetime-local" id="date_start" name="date_start" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="adr_prepare" class="block text-sm font-medium text-gray-700">Дата определения места</label>
                        <input type="datetime-local" id="adr_prepare" name="adr_prepare" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="tech_fin" class="block text-sm font-medium text-gray-700">Дата готовности техчасти</label>
                        <input type="datetime-local" id="tech_fin" name="tech_fin"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="equipment_fin" class="block text-sm font-medium text-gray-700">Дата заказа оборудования</label>
                        <input type="datetime-local" id="equipment_fin" name="equipment_fin"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="equipment_prepared" class="block text-sm font-medium text-gray-700">Дата комплектации</label>
                        <input type="datetime-local" id="equipment_prepared" name="equipment_prepared"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="contractor_accepted" class="block text-sm font-medium text-gray-700">Дата проектирования</label>
                        <input type="datetime-local" id="contractor_accepted" name="contractor_accepted"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="ready_for_work" class="block text-sm font-medium text-gray-700">Дата готовности к пуску</label>
                        <input type="datetime-local" id="ready_for_work" name="ready_for_work"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="params_fin" class="block text-sm font-medium text-gray-700">Дата готовности параметров</label>
                        <input type="datetime-local" id="params_fin" name="params_fin"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="integration_fin" class="block text-sm font-medium text-gray-700">Дата интеграции</label>
                        <input type="datetime-local" id="integration_fin" name="integration_fin"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="monitoring_fin" class="block text-sm font-medium text-gray-700">Дата мониторинга</label>
                        <input type="datetime-local" id="monitoring_fin" name="monitoring_fin"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="commisioning_fin" class="block text-sm font-medium text-gray-700">Дата окончания работ</label>
                        <input type="datetime-local" id="commisioning_fin" name="commisioning_fin"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                </div>

                <div class="flex justify-end pt-4">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded transition-colors">
                        Добавить мероприятие
                    </button>
                </div>
            </form>
        </div>
    </div>
</main>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Установка текущей даты и времени по умолчанию для обязательных полей
        const now = new Date();
        const timezoneOffset = now.getTimezoneOffset() * 60000;
        const localISOTime = (new Date(now - timezoneOffset)).toISOString().slice(0, 16);
        
        document.getElementById('date_start').value = localISOTime;
        document.getElementById('adr_prepare').value = localISOTime;
    });

    document.getElementById('event-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Собираем данные формы
        const formData = {
            packet_id: parseInt(document.getElementById('packet_id').value),
            year: parseInt(document.getElementById('year').value),
            type_of_work: parseFloat(document.getElementById('type_of_work').value),
            contractor: parseFloat(document.getElementById('contractor').value),
            idleft: parseInt(document.getElementById('idleft').value),
            idright: parseInt(document.getElementById('idright').value),
            g2: parseFloat(document.getElementById('g2').value),
            g3: parseFloat(document.getElementById('g3').value),
            g4: parseFloat(document.getElementById('g4').value),
            rrl: parseFloat(document.getElementById('rrl').value),
            a_index: parseInt(document.getElementById('a_index').value),
            a_region: parseFloat(document.getElementById('a_region').value),
            a_place: parseFloat(document.getElementById('a_place').value),
            date_start: document.getElementById('date_start').value,
            adr_prepare: document.getElementById('adr_prepare').value,
            tech_fin: document.getElementById('tech_fin').value || null,
            equipment_fin: document.getElementById('equipment_fin').value || null,
            equipment_prepared: document.getElementById('equipment_prepared').value || null,
            contractor_accepted: document.getElementById('contractor_accepted').value || null,
            ready_for_work: document.getElementById('ready_for_work').value || null,
            params_fin: document.getElementById('params_fin').value || null,
            integration_fin: document.getElementById('integration_fin').value || null,
            monitoring_fin: document.getElementById('monitoring_fin').value || null,
            commisioning_fin: document.getElementById('commisioning_fin').value || null
        };

        // Отправляем запрос
        fetch('/user/event/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw err; });
            }
            return response.json();
        })
        .then(data => {
            showNotification('success', 'Мероприятие успешно добавлено');
            console.log('Event added:', data);
            // Можно очистить форму или выполнить другие действия
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('error', error.detail || 'Ошибка при добавлении мероприятия');
        });
    });
</script>

{% include "foot.html" %}